<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Hafland Premium White</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #ffffff;
            --text: #000000;
            --border: #f0f0f0; /* Светло-серые линии */
            --glass: rgba(255, 255, 255, 0.85);
        }
        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            margin: 0; padding: 0;
            overflow: hidden; height: 100vh;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .glass-nav {
            background: var(--glass);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-top: 1px solid var(--border);
        }
        .glass-modal {
            background: var(--glass);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid var(--border);
        }
        .content-scroll {
            height: calc(100vh - 160px);
            overflow-y: auto;
        }
        .content-scroll::-webkit-scrollbar { display: none; }
        
        .btn-black {
            background: #000;
            color: #fff;
            transition: all 0.2s ease;
        }
        .btn-black:active { transform: scale(0.96); }
        
        .border-gray { border-color: var(--border); }
        
        input { outline: none; user-select: text !important; color: black; }
        
        .msg-me { background: #000; color: #fff; border-radius: 20px; }
        .msg-them { background: #f9f9f9; color: #000; border-radius: 20px; border: 1px solid var(--border); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    </style>
</head>
<body>
    <div id="app" class="h-full flex flex-col relative bg-white">
        <div id="loader" class="h-full flex flex-col items-center justify-center">
            <div class="w-8 h-8 border-2 border-gray-100 border-t-black rounded-full animate-spin"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAkgC4melkEcj0pDywonPG3aAeE3vACoF0",
            authDomain: "hafland-c8dc3.firebaseapp.com",
            projectId: "hafland-c8dc3",
            storageBucket: "hafland-c8dc3.firebasestorage.app",
            messagingSenderId: "163991622474",
            appId: "1:163991622474:web:06a7357e295c9a98b327b3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const APP_ID = "hafland_v3_minimal_white";

        window.state = {
            user: null, profile: null, tab: 'chats', chatMode: null,
            messages: [], users: [], terminal: ['[Secure Connection Initialized]'],
            giftTarget: null, giftAmount: 50,
            savedAccs: JSON.parse(localStorage.getItem('h_accs_white') || '[]'),
            authPrompt: null, nftDraft: null, isMarket: null
        };

        onAuthStateChanged(auth, async (u) => {
            if (u) {
                window.state.user = u;
                initListeners(u.uid);
            } else {
                renderAuth();
            }
        });

        function initListeners(uid) {
            onSnapshot(doc(db, 'artifacts', APP_ID, 'users', uid), (s) => {
                if (s.exists()) { 
                    window.state.profile = s.data(); 
                    render(); 
                } else { 
                    renderAuth(); 
                }
            });

            onSnapshot(collection(db, 'artifacts', APP_ID, 'users'), (s) => {
                window.state.users = s.docs.map(d => d.data());
                render();
            });

            onSnapshot(collection(db, 'artifacts', APP_ID, 'messages'), (s) => {
                const all = s.docs.map(d => d.data());
                window.state.messages = all.filter(m => m.from === uid || m.to === uid || m.to === 'bot').sort((a,b) => a.time - b.time);
                render();
            });
        }

        window.handleAuth = async (mode) => {
            const nick = document.getElementById('a-nick').value.trim().toLowerCase();
            const pass = document.getElementById('a-pass').value.trim();
            if(!nick || !pass) return;

            const regRef = doc(db, 'artifacts', APP_ID, 'registry', nick);
            const regSnap = await getDoc(regRef);

            if(mode === 'reg') {
                if(regSnap.exists()) return alert("Имя занято");
                const cred = await signInAnonymously(auth);
                const isAdmin = nick === 'hafa168';
                const profile = {
                    uid: cred.user.uid,
                    username: nick,
                    pass: pass,
                    stars: isAdmin ? 9999999 : 500,
                    tag: isAdmin ? 'ADMIN' : 'PREMIUM',
                    nfts: []
                };
                await setDoc(regRef, { uid: cred.user.uid, pass });
                await setDoc(doc(db, 'artifacts', APP_ID, 'users', cred.user.uid), profile);
                saveAcc(nick, pass, cred.user.uid);
            } else {
                if(!regSnap.exists() || regSnap.data().pass !== pass) return alert("Ошибка доступа");
                await signInAnonymously(auth);
                saveAcc(nick, pass, regSnap.data().uid);
            }
        };

        const saveAcc = (nick, pass, uid) => {
            let accs = JSON.parse(localStorage.getItem('h_accs_white') || '[]');
            if(!accs.find(a => a.nick === nick)) accs.push({nick, pass, uid});
            localStorage.setItem('h_accs_white', JSON.stringify(accs));
            window.state.savedAccs = accs;
        };

        window.switchAcc = (acc) => {
            window.state.authPrompt = acc;
            render();
        };

        window.verifySwitch = async () => {
            const p = document.getElementById('v-pass').value;
            if(p === window.state.authPrompt.pass) {
                await signOut(auth);
                window.state.authPrompt = null;
                location.reload();
            } else {
                alert("Доступ отклонен");
            }
        };

        window.sendMsg = async (to = null, txt = null) => {
            const input = document.getElementById('msg-input');
            const message = txt || input?.value.trim();
            const target = to || window.state.chatMode;
            if(!message || !target) return;
            if(input) input.value = '';

            await addDoc(collection(db, 'artifacts', APP_ID, 'messages'), {
                from: window.state.user.uid,
                to: target,
                text: message,
                sender: window.state.profile.username,
                tag: window.state.profile.tag,
                time: Date.now()
            });
        };

        window.sendStars = async () => {
            const amount = parseInt(window.state.giftAmount);
            const target = window.state.giftTarget;
            if(window.state.profile.stars < amount) return alert("Недостаточно звезд");
            
            const tRef = doc(db, 'artifacts', APP_ID, 'users', target.uid);
            const mRef = doc(db, 'artifacts', APP_ID, 'users', window.state.user.uid);
            
            const tSnap = await getDoc(tRef);
            await updateDoc(tRef, { stars: (tSnap.data().stars || 0) + amount });
            await updateDoc(mRef, { stars: window.state.profile.stars - amount });
            
            await sendMsg(target.uid, `[СИСТЕМА]: Вы получили ${amount} ★`);
            window.state.giftTarget = null;
            render();
        };

        window.forgeNFT = () => {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = 'image/*';
            input.onchange = e => {
                const reader = new FileReader();
                reader.onload = ev => {
                    window.state.nftDraft = ev.target.result;
                    window.state.isMarket = 'confirm';
                    render();
                };
                reader.readAsDataURL(e.target.files[0]);
            };
            input.click();
        };

        window.confirmNFT = async (tUid) => {
            if(window.state.profile.stars < 1000) return alert("Необходимо 1000 ★");
            const tRef = doc(db, 'artifacts', APP_ID, 'users', tUid);
            const tSnap = await getDoc(tRef);
            const nfts = tSnap.data().nfts || [];
            await updateDoc(tRef, { nfts: [...nfts, { id: Date.now(), img: window.state.nftDraft }] });
            await updateDoc(doc(db, 'artifacts', APP_ID, 'users', window.state.user.uid), { stars: window.state.profile.stars - 1000 });
            window.state.isMarket = null;
            render();
        };

        window.runTerm = () => {
            const i = document.getElementById('t-input');
            const v = i.value.trim();
            i.value = '';
            window.state.terminal.push(`> ${v}`);
            if(v.startsWith('hafamessage ')) {
                sendMsg('bot', v.replace('hafamessage ', ''));
                window.state.terminal.push('SYS: Message pushed to bot queue.');
            }
            render();
        };

        function renderAuth() {
            document.getElementById('app').innerHTML = `
                <div class="h-full flex flex-col items-center justify-center p-12 bg-white">
                    <div class="mb-12 text-center animate-in">
                        <h1 class="text-4xl font-black italic uppercase tracking-tighter">Hafland</h1>
                        <p class="text-[9px] font-bold text-gray-300 uppercase tracking-[0.4em] mt-1 italic">Personal Node</p>
                    </div>
                    <div class="w-full max-w-xs space-y-3">
                        <input id="a-nick" class="w-full p-5 rounded-3xl bg-white border border-gray-100 text-xs font-bold text-center" placeholder="USERNAME">
                        <input id="a-pass" type="password" class="w-full p-5 rounded-3xl bg-white border border-gray-100 text-xs font-bold text-center" placeholder="PASSWORD">
                        <div class="grid grid-cols-2 gap-3 pt-3">
                            <button onclick="handleAuth('login')" class="p-5 border border-gray-100 rounded-3xl text-[10px] font-black uppercase tracking-widest">Вход</button>
                            <button onclick="handleAuth('reg')" class="btn-black p-5 rounded-3xl text-[10px] font-black uppercase tracking-widest">Создать</button>
                        </div>
                    </div>
                </div>`;
            lucide.createIcons();
        }

        function render() {
            const s = window.state;
            if(!s.profile) return;

            const isAdmin = s.profile.username === 'hafa168';

            document.getElementById('app').innerHTML = `
                <header class="pt-16 px-8 pb-6 flex justify-between items-end border-b border-gray-100 bg-white">
                    <div>
                        <h2 class="text-2xl font-black italic uppercase tracking-tighter">Hafland</h2>
                        <p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mt-0.5">
                            ${s.chatMode ? (s.chatMode==='bot'?'Hafland AI':s.users.find(u=>u.uid===s.chatMode)?.username) : s.tab}
                        </p>
                    </div>
                    <div class="flex items-center gap-2 px-4 py-2 rounded-full border border-gray-100">
                        <span class="text-[11px] font-black">${s.profile.stars.toLocaleString()}</span>
                        <i data-lucide="zap" size="10" class="fill-black"></i>
                    </div>
                </header>

                <main class="content-scroll animate-in bg-white">
                    ${renderPage(isAdmin)}
                </main>

                <nav class="safe-nav glass-nav flex justify-around items-center pt-5 pb-9 fixed bottom-0 w-full z-50">
                    ${navItem('chats', 'message-square', 'Чаты')}
                    ${navItem('network', 'globe', 'Сеть')}
                    ${navItem('market', 'package', 'Рынок')}
                    ${isAdmin ? navItem('term', 'hash', 'Терм') : ''}
                    ${navItem('profile', 'user', 'Проф')}
                </nav>

                ${renderModals()}
            `;
            lucide.createIcons();
            const box = document.getElementById('chat-box'); if(box) box.scrollTop = box.scrollHeight;
        }

        function navItem(id, icon, label) {
            const active = window.state.tab === id;
            return `
                <button onclick="window.state.tab='${id}'; window.state.chatMode=null; render()" class="flex flex-col items-center">
                    <i data-lucide="${icon}" size="20" class="${active ? 'text-black' : 'text-gray-200'}"></i>
                    <span class="text-[8px] font-black uppercase mt-1 tracking-widest ${active ? 'text-black' : 'text-gray-200'}">${label}</span>
                </button>
            `;
        }

        function renderPage(isAdmin) {
            const s = window.state;
            if(s.tab === 'chats') {
                if(s.chatMode) {
                    const filtered = s.messages.filter(m => (m.from===s.user.uid && m.to===s.chatMode) || (m.from===s.chatMode && m.to===s.user.uid) || (s.chatMode==='bot' && (m.to==='bot' || m.from==='bot')));
                    return `
                        <div class="h-full flex flex-col px-8">
                            <div id="chat-box" class="flex-1 overflow-y-auto space-y-6 py-6 no-scrollbar">
                                <button onclick="window.state.chatMode=null;render()" class="text-[9px] font-black text-gray-300 uppercase flex items-center gap-1 mb-4"><i data-lucide="chevron-left" size="10"></i> Назад</button>
                                ${filtered.map(m => `
                                    <div class="flex ${m.from === s.user.uid ? 'justify-end' : 'justify-start'}">
                                        <div class="max-w-[85%]">
                                            <div class="${m.from === s.user.uid ? 'msg-me' : 'msg-them'} p-4 text-[13px] font-medium leading-relaxed">
                                                ${m.text}
                                            </div>
                                            <p class="text-[7px] font-black text-gray-300 uppercase mt-2 px-1 tracking-widest">${m.sender} • ${m.tag}</p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="py-6 flex gap-2">
                                <input id="msg-input" class="flex-1 bg-white border border-gray-100 p-4 rounded-2xl text-xs font-bold" placeholder="Сообщение..." onkeypress="if(event.key==='Enter') sendMsg()">
                                <button onclick="sendMsg()" class="btn-black w-12 h-12 rounded-2xl flex items-center justify-center"><i data-lucide="arrow-up" size="18"></i></button>
                            </div>
                        </div>
                    `;
                }
                const p = [...new Set(s.messages.map(m => m.from === s.user.uid ? m.to : m.from))];
                return `
                    <div class="p-8 space-y-3">
                        <h3 class="text-[9px] font-black text-gray-200 uppercase tracking-[0.2em] mb-4">Активные диалоги</h3>
                        ${p.includes('bot') ? `<button onclick="window.state.chatMode='bot';render()" class="w-full flex items-center gap-4 p-5 rounded-3xl border border-gray-100"><div class="w-10 h-10 bg-black text-white flex items-center justify-center rounded-xl font-black">AI</div><div class="text-left text-xs font-black uppercase italic">Hafland AI</div></button>` : ''}
                        ${p.filter(x=>x!=='bot'&&x!==s.user.uid).map(uid => {
                            const u = s.users.find(x=>x.uid===uid);
                            return u ? `<button onclick="window.state.chatMode='${uid}';render()" class="w-full flex items-center gap-4 p-5 rounded-3xl border border-gray-100"><div class="w-10 h-10 bg-gray-50 flex items-center justify-center rounded-xl font-black text-gray-200">${u.username[0].toUpperCase()}</div><div class="text-left"><div class="text-xs font-black uppercase tracking-tight">${u.username}</div><div class="text-[8px] text-gray-300 font-bold uppercase">${u.tag}</div></div></button>` : '';
                        }).join('')}
                    </div>
                `;
            }
            if(s.tab === 'network') {
                return `
                    <div class="p-8 space-y-3">
                        <h3 class="text-[9px] font-black text-gray-200 uppercase tracking-[0.2em] mb-4">Глобальная сеть</h3>
                        ${s.users.filter(u=>u.uid!==s.user.uid).map(u => `
                            <div class="flex items-center justify-between p-5 rounded-3xl border border-gray-100">
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 bg-gray-50 rounded-xl flex items-center justify-center text-gray-200 font-black">${u.username[0].toUpperCase()}</div>
                                    <div><div class="text-xs font-black uppercase">${u.username}</div><div class="text-[8px] text-gray-300 font-bold uppercase tracking-widest">${u.tag}</div></div>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="window.state.giftTarget=${JSON.stringify(u).replace(/"/g, '&quot;')};render()" class="p-2 text-gray-200 hover:text-black"><i data-lucide="gift" size="16"></i></button>
                                    <button onclick="window.state.tab='chats'; window.state.chatMode='${u.uid}'; render()" class="p-2 text-gray-200 hover:text-black"><i data-lucide="message-square" size="16"></i></button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            if(s.tab === 'term' && isAdmin) {
                return `<div class="p-8 h-full flex flex-col font-mono text-[10px]"><div class="flex-1 space-y-1 text-gray-300 overflow-y-auto no-scrollbar italic">${s.terminal.map(l=>`<div>${l}</div>`).join('')}</div><div class="pt-4 border-t border-gray-100 flex gap-2"><span class="font-black text-black">></span><input id="t-input" class="flex-1 bg-transparent font-bold text-black uppercase" onkeypress="if(event.key==='Enter') runTerm()" placeholder="Command..."></div></div>`;
            }
            if(s.tab === 'market') {
                return `<div class="p-10 flex flex-col items-center justify-center h-full text-center"><div class="w-16 h-16 border border-gray-100 rounded-3xl flex items-center justify-center mb-6"><i data-lucide="plus" class="text-gray-200"></i></div><h3 class="text-xs font-black uppercase mb-2 tracking-widest">NFT Forge</h3><p class="text-[10px] text-gray-300 max-w-[200px] mb-8 leading-relaxed italic">Создайте уникальный артефакт за 1,000 звезд.</p><button onclick="forgeNFT()" class="btn-black px-12 py-5 rounded-3xl text-[10px] font-black uppercase tracking-widest shadow-xl shadow-black/5">Создать</button></div>`;
            }
            if(s.tab === 'profile') {
                return `
                    <div class="p-10 flex flex-col items-center">
                        <div class="w-24 h-24 rounded-[2.8rem] border border-gray-100 flex items-center justify-center text-3xl font-black text-gray-200 mb-6 bg-white shadow-sm">
                            ${s.profile.username[0].toUpperCase()}
                        </div>
                        <h2 class="text-2xl font-black italic uppercase tracking-tighter">${s.profile.username}</h2>
                        <p class="text-[10px] font-bold text-gray-300 uppercase tracking-[0.4em] mt-1">${s.profile.tag}</p>
                        
                        <div class="w-full mt-10 space-y-2">
                            <p class="text-[9px] font-black text-gray-200 uppercase px-4 mb-2 tracking-widest">Защищенные узлы</p>
                            ${s.savedAccs.map(a => `
                                <div onclick="switchAcc(${JSON.stringify(a).replace(/"/g, '&quot;')})" class="flex items-center justify-between p-5 rounded-3xl border ${a.nick===s.profile.username?'border-black':'border-gray-100'}">
                                    <span class="text-xs font-black uppercase tracking-tight">${a.nick}</span>
                                    <i data-lucide="shield" size="12" class="${a.nick===s.profile.username?'text-black':'text-gray-100'}"></i>
                                </div>
                            `).join('')}
                            <button onclick="signOut(auth); location.reload();" class="w-full p-5 rounded-3xl border border-dashed border-gray-100 text-[10px] font-black text-gray-300 uppercase mt-4 tracking-widest">Добавить аккаунт +</button>
                        </div>
                        <div class="grid grid-cols-3 gap-2 w-full mt-10">
                            ${(s.profile.nfts||[]).map(n=>`<div class="aspect-square border border-gray-100 rounded-2xl overflow-hidden bg-white"><img src="${n.img}" class="w-full h-full object-cover grayscale opacity-80"></div>`).join('')}
                        </div>
                    </div>
                `;
            }
            return '';
        }

        function renderModals() {
            const s = window.state;
            if(s.authPrompt) return `
                <div class="fixed inset-0 z-[100] flex items-center justify-center p-8 bg-black/10 backdrop-blur-sm">
                    <div class="glass-modal p-10 rounded-[3rem] w-full max-w-xs shadow-2xl animate-in">
                        <h3 class="text-center font-black uppercase text-[10px] tracking-widest mb-6">Пароль доступа для ${s.authPrompt.nick}</h3>
                        <input id="v-pass" type="password" class="w-full p-5 bg-white border border-gray-100 rounded-2xl text-center text-xs font-bold mb-4" placeholder="...">
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="window.state.authPrompt=null;render()" class="p-5 border border-gray-100 rounded-2xl text-[10px] font-black uppercase">Назад</button>
                            <button onclick="verifySwitch()" class="btn-black p-5 rounded-2xl text-[10px] font-black uppercase">Войти</button>
                        </div>
                    </div>
                </div>
            `;
            if(s.giftTarget) return `
                <div class="fixed inset-0 z-[100] flex items-center justify-center p-8 bg-black/10 backdrop-blur-sm">
                    <div class="glass-modal p-10 rounded-[3rem] w-full max-w-xs shadow-2xl animate-in">
                        <h3 class="text-center font-black uppercase text-[10px] mb-6 tracking-widest italic">Передача: ${s.giftTarget.username}</h3>
                        <input type="number" oninput="window.state.giftAmount=this.value" class="w-full p-5 bg-white border border-gray-100 rounded-2xl text-center text-2xl font-black mb-6" value="50">
                        <button onclick="sendStars()" class="w-full btn-black p-5 rounded-3xl text-[10px] font-black uppercase tracking-widest">Подтвердить</button>
                        <button onclick="window.state.giftTarget=null;render()" class="w-full mt-4 text-[9px] font-black text-gray-300 uppercase tracking-widest">Отмена</button>
                    </div>
                </div>
            `;
            if(s.isMarket === 'confirm') return `
                <div class="fixed inset-0 z-[100] flex items-center justify-center p-8 bg-black/10 backdrop-blur-sm">
                    <div class="glass-modal p-8 rounded-[3rem] w-full max-w-xs shadow-2xl animate-in">
                        <h3 class="text-center font-black uppercase text-[10px] mb-4 tracking-widest">Отправить артефакт</h3>
                        <div class="w-24 h-24 mx-auto border border-gray-100 rounded-3xl overflow-hidden mb-6"><img src="${s.nftDraft}" class="w-full h-full object-cover"></div>
                        <div class="space-y-2 max-h-40 overflow-y-auto no-scrollbar">
                            ${s.users.filter(u=>u.uid!==s.user.uid).map(u=>`<button onclick="confirmNFT('${u.uid}')" class="w-full p-4 border border-gray-100 rounded-2xl text-left text-xs font-black flex justify-between uppercase"><span>${u.username}</span><span class="opacity-20">1k ★</span></button>`).join('')}
                        </div>
                        <button onclick="window.state.isMarket=null;render()" class="w-full mt-4 text-[9px] font-black text-gray-300 uppercase tracking-widest">Отмена</button>
                    </div>
                </div>
            `;
            return '';
        }

    </script>
</body>
</html>

